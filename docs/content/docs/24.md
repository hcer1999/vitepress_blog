---
title: Viteæ‰“åŒ…ä¼˜åŒ–åŸºæœ¬æ“ä½œ
date: 2024-01-03
permalink: /content
---

# Viteæ‰“åŒ…ä¼˜åŒ–åŸºæœ¬æ“ä½œ

æ‰“åŒ…ä¼˜åŒ–å…³è”ç€ç½‘ç«™çš„ç¨³å®šä¸åŠ è½½é€Ÿåº¦ï¼Œåœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ä¸€é¡¹

![serverConfig](../../assets/24/01.jpg)

## `vite` è‡ªèº«çš„æ„å»ºä¼˜åŒ–

ç‚¹å‡»æŸ¥çœ‹ [build-optimizations](https://cn.vitejs.dev/guide/features.html#build-optimizations) <Badge text="viteå®˜æ–¹æ–‡æ¡£"/>

## `postcss` é…ç½®

postcss å®˜ç½‘ï¼šwww.postcss.com.cn/

postcss æ˜¯ä¸€ä¸ªç”¨ JavaScript å·¥å…·å’Œæ’ä»¶è½¬æ¢ CSS ä»£ç çš„å·¥å…·ï¼Œpostcss è‡ªèº«æ²¡æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Œåªæ˜¯ä¸€ä¸ªå¹³å°ï¼Œå¯ä»¥ä¸‹è½½å„ç§æ’ä»¶ï¼Œä»è€Œå®ç°ä¸€äº›åŠŸèƒ½ï¼

- `Autoprefixer` è‡ªåŠ¨è·å–æµè§ˆå™¨çš„æµè¡Œåº¦å’Œèƒ½å¤Ÿæ”¯æŒçš„å±æ€§ï¼Œå¹¶æ ¹æ®è¿™äº›æ•°æ®å¸®ä½ è‡ªåŠ¨ä¸º CSS è§„åˆ™æ·»åŠ å‰ç¼€ã€‚
- `PostCSS Preset Env` å¸®ä½ å°†æœ€æ–°çš„ CSS è¯­æ³•è½¬æ¢æˆå¤§å¤šæ•°æµè§ˆå™¨éƒ½èƒ½ç†è§£çš„è¯­æ³•ï¼Œ
- CSS æ¨¡å— èƒ½è®©ä½ ä½ æ°¸è¿œä¸ç”¨æ‹…å¿ƒå‘½åå¤ªå¤§ä¼—åŒ–è€Œé€ æˆå†²çªï¼Œåªè¦ç”¨æœ€æœ‰æ„ä¹‰çš„åå­—å°±è¡Œäº†ã€‚
  æ³¨ï¼š`PostCSS Preset Env` å®é™…é¢„è®¾äº†å¾ˆå¤šå¥½ç”¨çš„ css æ’ä»¶ï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£`autoprefixer`ä½¿ç”¨ã€‚

postcss å¯ä»¥é€šè¿‡åœ¨æ ¹ç›®å½•åˆ›å»º`postcss.config.js`æ¥è¿›è¡Œé…ç½®ï¼Œå¦‚ï¼š

```js
const postcssPresetEnv = require('postcss-preset-env')
module.exports = {
  plugins: [postcssPresetEnv(/* pluginOptions */)],
}
```

### Vite ä¸­é…ç½® postcss

- åœ¨ vite.config.js å†…çš„ css.postcss å±æ€§å†…ç›´æ¥é…ç½®

```js
import { defineConfig } from 'vite'
export default defineConfig({
  css: {
    postcss: {
      // ä¸€äº›é…ç½®
    },
  },
})
```

#### postcss-preset-env

æˆ‘ä»¬ä¸»è¦ä½¿ç”¨`postcss-preset-env`æ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶æ”¯æŒ css å˜é‡å’Œä¸€äº›æœªæ¥ css è¯­æ³•ä»¥åŠè‡ªåŠ¨è¡¥å…¨(autoprefixer)

```js{7-14}
import { defineConfig } from "vite";
import postcssPresetEnv from "postcss-preset-env";
export default defineConfig({
  css: {
    postcss: {
      plugins: [
        postcssPresetEnv({
          // å…¶ä»–é€‰é¡¹
          stage: 0, // 0-4 0æ˜¯æœ€é«˜çº§åˆ« 4æ˜¯æœ€ä½çº§åˆ« é»˜è®¤æ˜¯2 è¿™ä¸ªé€‰é¡¹æ˜¯æŒ‡å®šè¦æ”¯æŒçš„æµè§ˆå™¨ç‰ˆæœ¬
          autoprefixer: {
            grid: true // æ˜¯å¦è‡ªåŠ¨æ·»åŠ å‰ç¼€
          }
        })
      ]
    }
  }
});
```

## ç»„ä»¶ã€å·¥å…·åº“

- æ— è®ºæ˜¯ç»„ä»¶ï¼ˆå¦‚ `element-plus`ï¼‰ï¼Œè¿˜æ˜¯å·¥å…·åº“ï¼ˆå¦‚ `lodash`ã€`axios`ï¼‰æˆ‘ä»¬éƒ½åº”è¯¥å°½å¯èƒ½çš„æŒ‰éœ€å¼•å…¥ï¼Œä½¿å…¶æœ‰è‰¯å¥½çš„ Â `tree-shaking` æ•ˆæœï¼Œè¿™æ ·é¡¹ç›®æ•´ä½“æ‰“åŒ…å‡ºæ¥çš„æ— ç”¨ä»£ç å°±å°‘ä¹‹åˆå°‘äº†

- æ‹¿ `lodash` ä¸¾ä¾‹ï¼Œ`lodash` é»˜è®¤æ˜¯ `cjs` æ ¼å¼ï¼Œä¸æ”¯æŒ `es6` çš„ `import` è¯­æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å» `github` æˆ–è€…æŸäº›æœç´¢å¼•æ“å»å¯»æ‰¾æ›¿ä»£å“ï¼Œæœ€ç»ˆå¹³å°æ‰¾åˆ°äº† `lodash-unified`ï¼Œå®ƒå®Œå…¨å…¼å®¹ `lodash` çš„å…¨éƒ¨è¯­æ³•å¹¶ä¸”æ—¢æ”¯æŒ `esm` åˆæ”¯æŒ `cjs`ï¼Œè¿™ä½¿å¾—å®ƒæ— è®ºåœ¨æµè§ˆå™¨è¿˜æ˜¯ `node` ç¯å¢ƒä¸­è¡¨ç°éƒ½å¾ˆè‰¯å¥½ã€‚å½“ç„¶å¦‚æœé‡åˆ°é‚£ç§åªæ”¯æŒ `cjs` æ ¼å¼ï¼Œç½‘ä¸Šæ‰¾éäº†éƒ½æ‰¾ä¸åˆ°å…¼å®¹ `esm` æ ¼å¼çš„å’‹åŠå‘¢ï¼Œè¿™æ—¶ä½ å¯ä»¥å‚è€ƒ `lodash-unified`ï¼Œçœ‹çœ‹åˆ«äººæ˜¯å¦‚ä½•è½¬æ¢çš„ ğŸ˜Š

- å¹³å°ç²¾ç®€ç‰ˆé¦–æ¬¡å¯åŠ¨æ—¶é—´æˆ‘è¿™è¾¹æµ‹è¯•æ˜¯ `6` ç§’ï¼Œåˆ·æ–°é¡µé¢çš„è¯å¼€å¯ [CachingAsyncRoutes](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/public/serverConfig.json#L19) å¯èƒ½è¿ `1` ç§’éƒ½ä¸è¦ï¼Œå¯çœ‹ä¸‹é¢çš„è§†é¢‘ã€‚å¦‚æœæ‚¨ä½¿ç”¨ `pure-admin` ä¸”å½“å‰ç½‘é¡µ`é¦–å¯åŠ¨`å’Œ`åˆ·æ–°é¡µé¢`çš„ç­‰å¾…æ—¶é—´è¿œè¿œå¤§äºå‰é¢çš„æ•°å­—ï¼Œä¹Ÿè¯¥è€ƒè™‘ä¼˜åŒ–äº†ã€‚å½“é¡¹ç›®å…·æœ‰ä¸€å®šè§„æ¨¡çš„æ—¶å€™ï¼Œä¼˜åŒ–å¹¶æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œæ‰€ä»¥æ‚¨åœ¨å†™ä»£ç å‰å°±åº”è¯¥éµå¾ªæˆ‘ä¸Šé¢çš„è¯´æ³•ï¼ŒæŒ‰éœ€å¼•å…¥æ‰æ˜¯ `yyds` ğŸ˜„  
  <video width="320" height="240" controls><source src="https://cdn.bingkele.cc/001.mov" type="video/mp4"></video>

- `vite` ç›®å‰æœ€å¤§çš„æ€§èƒ½ç“¶é¢ˆæ˜¯å¤§é‡æ¨¡å—çš„é¦–é¡µåŠ è½½ï¼Œå¯çœ‹ [vite-issues](https://github.com/vitejs/vite/issues/1309#issue-777569758)ï¼Œå€¼å¾—æœŸå¾…çš„æ˜¯è¿™ä¸ª [pr](https://github.com/vitejs/vite/pull/10671) å¯èƒ½ä¼šç¼“è§£è¿™ä¸ªéº»çƒ¦

## å‹ç¼© `gzip`ã€`brotli` æ ¼å¼

ä½¿ç”¨ [vite-plugin-compression](https://github.com/vbenjs/vite-plugin-compression) å¯¹å¹³å°è¿›è¡Œ `gzip` æˆ–è€… `brotli` å‹ç¼©ï¼Œ`nginx` å¯¹è¿™ä¸¤ç§å‹ç¼©æ¨¡å¼éƒ½æ”¯æŒï¼Œå‹ç¼©åéƒ¨ç½²åˆ° `nginx` å°†æå¤§æé«˜ç½‘é¡µåŠ è½½é€Ÿåº¦

### å¦‚ä½•å¼€å¯å‹ç¼©

æ¥åˆ° `.env.production` æ–‡ä»¶ï¼Œè®¾ç½® [VITE_COMPRESSION](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/.env.production#L13) å³å¯ã€‚è®¾ç½®æ€»ä½“åˆ†ä¸ºä¸‹é¢ä¸¤ç§ [å…·ä½“å®ç°ä»£ç ](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/build/compress.ts)

#### ä¸¤ç§æ€»ä½“è®¾ç½®

1. å‹ç¼©æ—¶ä¸åˆ é™¤åŸå§‹æ–‡ä»¶çš„é…ç½®
2. å‹ç¼©æ—¶åˆ é™¤åŸå§‹æ–‡ä»¶çš„é…ç½®

##### å‹ç¼©æ—¶ä¸åˆ é™¤åŸå§‹æ–‡ä»¶çš„é…ç½®

```.env.production
å¼€å¯ gzip å‹ç¼©
VITE_COMPRESSION = "gzip"

å¼€å¯ brotli å‹ç¼©
VITE_COMPRESSION = "brotli"

# åŒæ—¶å¼€å¯ gzip ä¸ brotli å‹ç¼©
VITE_COMPRESSION = "both"

# ä¸å¼€å¯å‹ç¼©ï¼Œé»˜è®¤
VITE_COMPRESSION = "none"
```

##### å‹ç¼©æ—¶åˆ é™¤åŸå§‹æ–‡ä»¶çš„é…ç½®

```.env.production
å¼€å¯ gzip å‹ç¼©
VITE_COMPRESSION = "gzip-clear"

å¼€å¯ brotli å‹ç¼©
VITE_COMPRESSION = "brotli-clear"

# åŒæ—¶å¼€å¯ gzip ä¸ brotli å‹ç¼©
VITE_COMPRESSION = "both-clear"

# ä¸å¼€å¯å‹ç¼©ï¼Œé»˜è®¤
VITE_COMPRESSION = "none"
```

## é‡‡ç”¨ `cdn` æ¨¡å¼æ›¿æ¢æœ¬åœ°ä¾èµ–

### `vite` æ’ä»¶

ä½¿ç”¨ [vite-plugin-cdn-import](https://github.com/MMF-FE/vite-plugin-cdn-import/blob/master/README.zh-CN.md) æ’ä»¶ï¼Œåœ¨æ‰“åŒ…æ—¶å°†æŒ‡å®šçš„ `modules` æ›¿æ¢æˆ `cdn` é“¾æ¥ï¼Œä»è€Œå‡å°‘æ„å»ºæ—¶é—´ï¼Œæé«˜ç”Ÿäº§ç¯å¢ƒä¸­é¡µé¢åŠ è½½é€Ÿåº¦ã€‚

### `cdn` å‚å•†ï¼ˆå…è´¹ï¼‰

å¹³å° `cdn` é‡‡ç”¨çš„æ˜¯å›½å†… [bootcdn](https://www.bootcdn.cn)ï¼Œä¸»è¦æ˜¯ç¨³å®šå¹¶ä¸”å¿«ï¼Œå½“ç„¶æ‚¨ä¹Ÿå¯ä»¥é€‰æ‹© [unpkg](https://unpkg.com) æˆ–è€… [jsdelivr](https://www.jsdelivr.com)ï¼Œè¿™ä¸¤ä¸ª `cdn` æ˜¯å›½å¤–çš„

### å¦‚ä½•å¯åŠ¨ `cdn` æ›¿æ¢

æ¥åˆ° `.env.production` æ–‡ä»¶ï¼Œå°† [VITE_CDN](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/.env.production#L8) è®¾ç½®æˆ `true` å³å¯

### é»˜è®¤å¯åŠ¨ `cdn` æ›¿æ¢çš„æ¨¡å—æœ‰å“ªäº›

`vue`ã€`vue-router`ã€`vue-demi`ã€`pinia`ã€`element-plus`ã€`axios`ã€`dayjs`ã€`echarts` å…·ä½“ä»£ç  [build/cdn.ts](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/build/cdn.ts)

## ç”Ÿäº§ç¯å¢ƒåˆ é™¤ `console.log`

ä½¿ç”¨å¹³å°å¼€å‘çš„ [vite-plugin-remove-console](https://github.com/xiaoxian521/vite-plugin-remove-console) æ’ä»¶ï¼Œåœ¨æ‰“åŒ…æ„å»ºæ—¶ç§»é™¤å¹³å°ä¸­æ‰€æœ‰çš„ `console.log`

## é™æ€èµ„æºåˆ†ç±»æ‰“åŒ…

`vite` æ˜¯åŸºäº `esbuild` å’Œ `rollup` æ„å»ºçš„ï¼Œåœ¨æ‰“åŒ…æ—¶å¦‚æœä¸è¿›è¡Œ `output` çš„é…ç½®ï¼Œå°±ä¼šæŠŠæ‰€æœ‰æ–‡ä»¶éƒ½æ··åœ¨ä¸€èµ·ï¼‰

åœ¨é…ç½®`output`åçš„æ•ˆæœï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½è¿›è¡Œäº†åˆ†ç±»å­˜æ”¾ï¼Œè¿™ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬æŸ¥æ‰¾æ–‡ä»¶

æ¥åˆ° vite.config.js æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯¹ output è¿›è¡Œäº†å¦‚ä¸‹é…ç½®

```js {9-13}
build: {
  sourcemap: false,
  // æ¶ˆé™¤æ‰“åŒ…å¤§å°è¶…è¿‡500kbè­¦å‘Š
  chunkSizeWarningLimit: 4000,
  rollupOptions: {
    input: {
      index: pathResolve("index.html")
    },
    // é™æ€èµ„æºåˆ†ç±»æ‰“åŒ…
    output: {
      chunkFileNames: "static/js/[name]-[hash].js",
      entryFileNames: "static/js/[name]-[hash].js",
      assetFileNames: "static/[ext]/[name]-[hash].[ext]"
    }
  }
}
```

:::tip ç›¸å…³æ¨è
[Vite ä»£ç æ‹†åŒ…æ’ä»¶ã€‚æ”¯æŒå¤šç§æ‹†åŒ…ç­–ç•¥ï¼Œå¯é¿å…æ‰‹åŠ¨æ“ä½œ manualChunks æ½œåœ¨çš„å¾ªç¯ä¾èµ–é—®é¢˜](https://github.com/sanyuan0704/vite-plugin-chunk-split/blob/master/README-CN.md)
:::

## `svg` å‹ç¼©

ä¸€èˆ¬ä¸‹è½½çš„ `svg` æˆ–è€…å¤åˆ¶çš„ `svg` ä»£ç ï¼Œé‡Œé¢å­˜åœ¨ä¸€äº›æ— å…³ç´§è¦çš„å…ƒç´ ï¼Œå¯ä»¥å°†å…¶å‰”é™¤ï¼Œæ¯«æ— å½±å“åœ°é™ä½ `svg` å¤§å°  
å¹³å°ä½¿ç”¨äº† [svgo](https://www.npmjs.com/package/svgo) å·¥å…·å¯¹æ‰€æœ‰ `svg` è¿›è¡Œäº†å‹ç¼©ï¼Œæ‚¨æ‹‰å–å¹³å°ä»£ç æ—¶æ‰€æœ‰ `svg` éƒ½å·²ç»æœ€ç®€äº†å“¦ã€‚å½“ç„¶æ‚¨ä¼šé—®è‡ªå·±æ–°åŠ çš„ `svg` å¦‚ä½•ç²¾ç®€å‘¢ï¼Œæ¥åˆ° [main/package.json](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/package.json#L14)ï¼Œå¯ä»¥çœ‹åˆ°å¹³å°é»˜è®¤ä½¿ç”¨ `svgo` å·¥å…·å¯¹ `src/assets/svg` æ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰ `svg` è¿›è¡Œå‹ç¼©ï¼Œè¿™æ˜¯å¯ä»¥æ”¹åŠ¨çš„ï¼Œåªéœ€è¦å°† `-f` å’Œ `-o` åçš„è·¯å¾„æ”¹ä¸ºæ‚¨éœ€è¦å‹ç¼©çš„ `svg` è·¯å¾„å³å¯ã€‚æ¸©é¦¨æç¤ºï¼šåªéœ€è¦è¿è¡Œ `pnpm svgo` å‘½ä»¤å¯¹ `svg` æ–‡ä»¶è¿›è¡Œä¸€æ¬¡å‹ç¼©å³å¯

:::tip æ¨èé˜…è¯»

- [æ€§èƒ½ä¼˜åŒ–](https://cn.vuejs.org/guide/best-practices/performance.html) <Badge text="vueæ–‡æ¡£"/>
- [Vite ä¸­ç»„ä»¶æŒ‰ç»„åˆ†å—æ‰“åŒ…](https://router.vuejs.org/zh/guide/advanced/lazy-loading.html#%E4%BD%BF%E7%94%A8-vite) <Badge text="vue-routeræ–‡æ¡£"/>
  :::

::: tip ä¼ é€é—¨
[åŸæ–‡åœ°å€](https://yiming_chang.gitee.io/pure-admin-doc/pages/buildgood/#vite-%E8%87%AA%E8%BA%AB%E7%9A%84%E6%9E%84%E5%BB%BA%E4%BC%98%E5%8C%96)
:::
