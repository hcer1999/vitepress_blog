---
author: 'bingkele'
title: '200 è¡Œ JavaScript çš„è™šæ‹Ÿ DOM'
date: '2024-7-15'
permalink: /content
---

# ä¸€ä¸ª200è¡ŒJavaScriptä»£ç çš„è™šæ‹ŸDOM

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»ä¸€ä¸ªè¶…è¿‡200è¡Œçš„å®Œæ•´è™šæ‹ŸDOMçš„å®ç°ã€‚

ç»“æœæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ä¸”æ€§èƒ½è¶³å¤Ÿçš„è™šæ‹ŸDOMåº“ï¼ˆ[æ¼”ç¤º](https://lazamar.github.io/virtual-dom/demos/)ï¼‰ã€‚

å®ƒåœ¨NPMä¸Šä½œä¸º`smvc`åŒ…æä¾›ã€‚

ä¸»è¦ç›®æ ‡æ˜¯é˜é‡ŠåƒReactè¿™æ ·çš„å·¥å…·èƒŒåçš„åŸºæœ¬æŠ€æœ¯ã€‚

Reactã€Vueå’ŒElmè¯­è¨€éƒ½é€šè¿‡å…è®¸æ‚¨æè¿°é¡µé¢çš„å¤–è§‚ï¼Œè€Œä¸å¿…æ‹…å¿ƒæ·»åŠ /åˆ é™¤å…ƒç´ ï¼Œæ¥ç®€åŒ–äº¤äº’å¼ç½‘é¡µçš„åˆ›å»ºã€‚

## è™šæ‹ŸDOMçš„ç›®æ ‡

è¿™ä¸æ˜¯å…³äºæ€§èƒ½çš„ã€‚

è™šæ‹ŸDOMæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œç”¨äºç®€åŒ–UIçš„ä¿®æ”¹è¡Œä¸ºã€‚

æ‚¨æè¿°æ‚¨å¸Œæœ›é¡µé¢çœ‹èµ·æ¥å¦‚ä½•ï¼Œåº“ä¼šè´Ÿè´£å°†DOMä»å½“å‰çŠ¶æ€æ›´æ”¹ä¸ºæ‚¨æƒ³è¦çš„çŠ¶æ€ã€‚

## å…³é”®æ€æƒ³

åº“å°†æ¥ç®¡ä¸€ä¸ªå•ä¸€çš„DOMå…ƒç´ å¹¶åœ¨å…¶ä¸­æ“ä½œã€‚

è¿™ä¸ªå…ƒç´ æœ€åˆåº”è¯¥æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬å‡è®¾é™¤äº†æˆ‘ä»¬çš„åº“ä¹‹å¤–ï¼Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿ä¼šä¿®æ”¹å®ƒã€‚

è¿™å°†æ˜¯ç”¨æˆ·åº”ç”¨ç¨‹åºçš„æ ¹ã€‚

å¦‚æœæˆ‘ä»¬åªèƒ½ä¿®æ”¹å®ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç¡®åˆ‡çŸ¥é“è¿™ä¸ªå…ƒç´ å†…éƒ¨æœ‰ä»€ä¹ˆï¼Œè€Œæ— éœ€æ£€æŸ¥å®ƒã€‚

æ€ä¹ˆåšï¼Ÿé€šè¿‡è·Ÿè¸ªæˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢å¯¹å®ƒæ‰€åšçš„æ‰€æœ‰ä¿®æ”¹ã€‚

æˆ‘ä»¬å°†é€šè¿‡ä¿æŒä¸€ä¸ªåŒ…å«æ¯ä¸ªHTMLå…ƒç´ ç®€åŒ–è¡¨ç¤ºçš„ç»“æ„æ¥è·Ÿè¸ªæˆ‘ä»¬çš„æ ¹èŠ‚ç‚¹å†…éƒ¨æ˜¯ä»€ä¹ˆã€‚

æˆ–è€…æ›´å‡†ç¡®åœ°è¯´ï¼Œæ¯ä¸ªDOMèŠ‚ç‚¹ã€‚

å› ä¸ºè¿™ç§è¡¨ç¤ºæ˜¯DOMèŠ‚ç‚¹çš„åæ˜ ï¼Œä½†å®ƒä¸åœ¨çœŸå®çš„DOMä¸­ï¼Œè®©æˆ‘ä»¬ç§°å®ƒä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå®ƒå°†æ„æˆæˆ‘ä»¬çš„è™šæ‹ŸDOMã€‚

ç”¨æˆ·æ°¸è¿œä¸ä¼šåˆ›å»ºçœŸå®çš„DOMèŠ‚ç‚¹ï¼Œåªæœ‰é‚£äº›è™šæ‹Ÿçš„ã€‚

ä»–ä»¬å°†é€šè¿‡ä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹å‘Šè¯‰æˆ‘ä»¬æ•´ä¸ªé¡µé¢åº”è¯¥å¦‚ä½•çœ‹èµ·æ¥ã€‚

ç„¶åæˆ‘ä»¬çš„åº“å°†è´Ÿè´£ä¿®æ”¹çœŸå®çš„DOMï¼Œä½¿å…¶ç¬¦åˆæˆ‘ä»¬çš„è¡¨ç¤ºã€‚

ä¸ºäº†çŸ¥é“è¦ä¿®æ”¹ä»€ä¹ˆï¼Œæˆ‘ä»¬çš„åº“å°†è·å–ç”¨æˆ·åˆ›å»ºçš„è™šæ‹ŸDOMï¼Œå¹¶å°†å…¶ä¸ä»£è¡¨é¡µé¢å½“å‰å¤–è§‚çš„è™šæ‹ŸDOMè¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º*diffing*ã€‚

å®ƒå°†è®°å½•å·®å¼‚ï¼Œä¾‹å¦‚åº”è¯¥æ·»åŠ æˆ–åˆ é™¤å“ªäº›å…ƒç´ ï¼Œä»¥åŠåº”è¯¥æ·»åŠ æˆ–åˆ é™¤å“ªäº›å±æ€§ã€‚*diffing*çš„è¾“å‡ºæ˜¯ä¸€ä¸ªè™šæ‹ŸDOM*diff*ã€‚

ç„¶åæˆ‘ä»¬å°†*apply*é‚£ä¸ªdiffä¸­çš„æ›´æ”¹åˆ°çœŸå®çš„DOMä¸Šã€‚ä¸€æ—¦æˆ‘ä»¬å®Œæˆä¿®æ”¹ï¼Œ

ç”¨æˆ·åˆ›å»ºçš„è™šæ‹ŸDOMç°åœ¨å·²ç»æˆä¸ºçœŸå®DOMçš„å½“å‰å¿ å®è¡¨ç¤ºã€‚

æ‰€ä»¥ï¼Œå¯¹äºUIéƒ¨åˆ†ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. _Create_ ä¸€ä¸ªDOMçš„è™šæ‹Ÿè¡¨ç¤º
2. _Diff_ è™šæ‹ŸDOMèŠ‚ç‚¹
3. _Apply_ ä¸€ä¸ªè™šæ‹ŸDOM diffåˆ°ä¸€ä¸ªHTMLå…ƒç´ 

æ„å»ºä¹‹åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•é€šè¿‡åœ¨å‡ è¡Œä»£ç ä¸­æ·»åŠ çŠ¶æ€å¤„ç†ï¼Œå°†è¿™æ ·çš„è™šæ‹ŸDOMç”¨äºä¸€ä¸ªå¼ºå¤§çš„åº“ã€‚

## è¡¨ç¤ºDOM

æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªç»“æ„åŒ…å«å°½å¯èƒ½å°‘çš„ä¿¡æ¯ï¼Œä»¥å¿ å®åœ°è¡¨ç¤ºé¡µé¢ä¸Šçš„å†…å®¹ã€‚

ä¸€ä¸ªDOMèŠ‚ç‚¹æœ‰ä¸€ä¸ªæ ‡ç­¾ï¼ˆ`div`ã€`p`ã€`span`ç­‰ï¼‰ï¼Œå±æ€§å’Œå­èŠ‚ç‚¹ã€‚

æ‰€ä»¥è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå…·æœ‰è¿™äº›å±æ€§çš„å¯¹è±¡æ¥è¡¨ç¤ºå®ƒä»¬ã€‚

```js
const exampleButton = {
  tag: 'button',
  properties: { class: 'primary', disabled: true, onClick: doSomething },
  children: [], // ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ•°ç»„
}
```

æˆ‘ä»¬è¿˜éœ€è¦ä¸€ç§æ–¹å¼æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚æ–‡æœ¬èŠ‚ç‚¹æ²¡æœ‰æ ‡ç­¾ï¼Œå±æ€§æˆ–å­èŠ‚ç‚¹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå…·æœ‰å•ä¸ªå±æ€§çš„å¯¹è±¡æ¥åŒ…å«æ–‡æœ¬å†…å®¹ã€‚

```js
const exampleText = {
  text: 'Hello World',
}
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥`tag`æˆ–`text`å±æ€§æ˜¯å¦å­˜åœ¨æ¥åŒºåˆ†æ–‡æœ¬è™šæ‹ŸèŠ‚ç‚¹å’Œå…ƒç´ èŠ‚ç‚¹ã€‚

å°±æ˜¯è¿™æ ·ï¼è¿™å·²ç»æ˜¯æˆ‘ä»¬å®Œå…¨æŒ‡å®šçš„è™šæ‹ŸDOMäº†ã€‚

æˆ‘ä»¬å¯ä»¥ä¸ºç”¨æˆ·åˆ›å»ºè¿™äº›ç±»å‹çš„èŠ‚ç‚¹åˆ›å»ºä¸€äº›ä¾¿åˆ©å‡½æ•°ã€‚

```js
function h(tag, properties, children) {
  return { tag, properties, children }
}

function text(content) {
  return { text: content }
}
```

ç°åœ¨å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ›å»ºå¤æ‚çš„åµŒå¥—ç»“æ„ã€‚

```js
const pausedScreen = h('div', {}, [
  h('h2', {}, text('Game Paused')),
  h('button', { onClick: resumeGame }, [text('Resume')]),
  h('button', { onClick: quitGame }, [text('Quit')]),
])
```

## Diffing

åœ¨å¼€å§‹diffingä¹‹å‰ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹æˆ‘ä»¬å¸Œæœ›diffingæ“ä½œçš„è¾“å‡ºæ˜¯ä»€ä¹ˆæ ·çš„ã€‚

ä¸€ä¸ªdiffåº”è¯¥æè¿°å¦‚ä½•ä¿®æ”¹ä¸€ä¸ªå…ƒç´ ã€‚æˆ‘èƒ½æƒ³åˆ°å‡ ç§ç±»å‹çš„ä¿®æ”¹ï¼š

- _Create_ - å‘DOMæ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚åº”è¯¥åŒ…å«è¦æ·»åŠ çš„è™šæ‹ŸDOMèŠ‚ç‚¹ã€‚
- _Remove_ - ä¸éœ€è¦åŒ…å«ä»»ä½•ä¿¡æ¯ã€‚
- _Replace_ - ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†ç”¨ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ›¿æ¢å®ƒã€‚åº”è¯¥åŒ…å«è¦æ·»åŠ çš„èŠ‚ç‚¹ã€‚
- _Modify an existing node_ - åº”è¯¥åŒ…å«è¦æ·»åŠ çš„å±æ€§ï¼Œè¦ç§»é™¤çš„å±æ€§ï¼Œä»¥åŠå¯¹å­èŠ‚ç‚¹çš„ä¿®æ”¹æ•°ç»„ã€‚
- _Donâ€™t modify_ - å…ƒç´ ä¿æŒä¸å˜ï¼Œæ²¡æœ‰ä»€ä¹ˆè¦åšçš„ã€‚

æ‚¨å¯èƒ½ä¼šæƒ³çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬é™¤äº†`create`å’Œ`remove`ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ª`replace`ä¿®æ”¹ã€‚

è¿™æ˜¯å› ä¸ºé™¤éç”¨æˆ·ä¸ºæ¯ä¸ªè™šæ‹ŸDOMèŠ‚ç‚¹æä¾›å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¦åˆ™æˆ‘ä»¬æ²¡æœ‰åŠæ³•çŸ¥é“å…ƒç´ å­èŠ‚ç‚¹çš„é¡ºåºæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚

è€ƒè™‘è¿™ä¸ªæƒ…å†µï¼Œæœ€åˆçš„DOMæè¿°æ˜¯è¿™æ ·çš„ï¼š

```js
{ tag: "div",
  properties: {},
  children: [
   { text: "One" },
   { text: "Two" },
   { text: "Three" }
  ]
}

```

ç„¶ååç»­çš„æè¿°æ˜¯è¿™æ ·çš„

```js
{ tag: "div",
  properties: {},
  children: [
   { text: "Three" }
   { text: "Two" },
   { text: "One" },
  ]
}

```

è¦æ³¨æ„åˆ°ä¸€å’Œä¸‰äº¤æ¢äº†ä½ç½®ï¼Œæˆ‘ä»¬å¿…é¡»å°†ç¬¬ä¸€ä¸ªå¯¹è±¡çš„æ¯ä¸ªå­èŠ‚ç‚¹ä¸ç¬¬äºŒä¸ªå¯¹è±¡çš„æ¯ä¸ªå­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚

è¿™ä¸èƒ½æœ‰æ•ˆåœ°å®Œæˆã€‚æ‰€ä»¥ç›¸åï¼Œæˆ‘ä»¬é€šè¿‡å®ƒä»¬åœ¨`children`æ•°ç»„ä¸­çš„ç´¢å¼•æ¥è¯†åˆ«å…ƒç´ ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬å°†`replace`æ•°ç»„çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚

è¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬åªèƒ½åœ¨ä½œä¸ºæœ€åä¸€ä¸ªå­èŠ‚ç‚¹æ’å…¥å…ƒç´ æ—¶ä½¿ç”¨`create`ã€‚

æ‰€ä»¥é™¤éæˆ‘ä»¬æ­£åœ¨æ·»åŠ å­èŠ‚ç‚¹ï¼Œå¦åˆ™æˆ‘ä»¬å°†ä½¿ç”¨`replace`ã€‚

ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥å®ç°è¿™ä¸ª`diff`å‡½æ•°ã€‚

```js
// å®ƒéœ€è¦ä¸¤ä¸ªè¦æ¯”è¾ƒçš„èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ—§çš„å’Œä¸€ä¸ªæ–°çš„ã€‚
function diffOne(l, r) {
  // é¦–å…ˆæˆ‘ä»¬å¤„ç†æ–‡æœ¬èŠ‚ç‚¹ã€‚å¦‚æœå®ƒä»¬çš„æ–‡æœ¬å†…å®¹ä¸æ˜¯
  // å®Œå…¨ç›¸åŒï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬ç”¨æ–°çš„æ›¿æ¢æ—§çš„ã€‚
  // å¦åˆ™å®ƒæ˜¯ä¸€ä¸ª`noop`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸åšã€‚
  const isText = l.text !== undefined
  if (isText) {
    return l.text !== r.text ? { replace: r } : { noop: true }
  }

  // æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å¤„ç†å…ƒç´ èŠ‚ç‚¹ã€‚
  // å¦‚æœæ ‡ç­¾æ›´æ”¹äº†ï¼Œæˆ‘ä»¬åº”è¯¥ç›´æ¥æ›¿æ¢æ•´ä¸ªä¸œè¥¿ã€‚

  if (l.tag !== r.tag) {
    return { replace: r }
  }

  // ç°åœ¨æ›¿æ¢å·²ç»è§£å†³ï¼Œæˆ‘ä»¬å¯èƒ½åªèƒ½ä¿®æ”¹å…ƒç´ ã€‚
  // é‚£ä¹ˆè®©æˆ‘ä»¬å…ˆè®°å½•åº”è¯¥åˆ é™¤çš„å±æ€§ã€‚
  // ä»»ä½•åœ¨æ–°èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨çš„å±æ€§éƒ½åº”è¯¥è¢«åˆ é™¤ã€‚
  const remove = []
  for (const prop in l.properties) {
    if (r.properties[prop] === undefined) {
      remove.push(prop)
    }
  }

  // ç°åœ¨è®©æˆ‘ä»¬æ£€æŸ¥å“ªäº›åº”è¯¥è¢«è®¾ç½®ã€‚
  // è¿™åŒ…æ‹¬æ–°çš„å’Œä¿®æ”¹è¿‡çš„å±æ€§ã€‚
  // é™¤éå±æ€§çš„å€¼åœ¨æ—§çš„å’Œæ–°çš„èŠ‚ç‚¹ä¸­æ˜¯ç›¸åŒçš„ï¼Œå¦åˆ™æˆ‘ä»¬å°†æ³¨æ„å®ƒã€‚
  const set = {}
  for (const prop in r.properties) {
    if (r.properties[prop] !== l.properties[prop]) {
      set[prop] = r.properties[prop]
    }
  }

  // æœ€åæˆ‘ä»¬diffå­èŠ‚ç‚¹åˆ—è¡¨ã€‚
  const children = diffList(l.children, r.children)

  return { modify: { remove, set, children } }
}
```

ä½œä¸ºä¸€ä¸ªä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°å½“æ²¡æœ‰ä»»ä½•å±æ€§æ›´æ”¹ï¼Œå¹¶ä¸”æ‰€æœ‰å­èŠ‚ç‚¹ä¿®æ”¹éƒ½æ˜¯noopsæ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿å…ƒç´ çš„diffæˆä¸º`noop`ã€‚

ï¼ˆåƒè¿™æ ·ï¼‰

å­èŠ‚ç‚¹åˆ—è¡¨çš„diffingè¶³å¤Ÿç›´æ¥ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªdiffåˆ—è¡¨ï¼Œå¤§å°ä¸ºæ¯”è¾ƒçš„ä¸¤ä¸ªåˆ—è¡¨ä¸­æœ€é•¿çš„ä¸€ä¸ªã€‚

å¦‚æœæ—§çš„æ›´é•¿ï¼Œå¤šä½™çš„å…ƒç´ åº”è¯¥è¢«ç§»é™¤ã€‚å¦‚æœæ–°çš„æ›´é•¿ï¼Œå¤šä½™çš„å…ƒç´ åº”è¯¥è¢«åˆ›å»ºã€‚

æ‰€æœ‰å…±åŒçš„å…ƒç´ éƒ½åº”è¯¥è¢«diffã€‚

```js
function diffList(ls, rs) {
  const length = Math.max(ls.length, rs.length)
  return Array.from({ length }).map((_, i) =>
    ls[i] === undefined
      ? { create: rs[i] }
      : rs[i] == undefined
        ? { remove: true }
        : diffOne(ls[i], rs[i]),
  )
}
```

diffingå®Œæˆäº†ï¼

## åº”ç”¨diff

æˆ‘ä»¬å·²ç»å¯ä»¥åˆ›å»ºä¸€ä¸ªè™šæ‹ŸDOMå¹¶diffå®ƒã€‚ç°åœ¨è½®åˆ°å°†diffåº”ç”¨åˆ°çœŸå®çš„DOMäº†ã€‚

`apply`å‡½æ•°å°†æ¥æ”¶ä¸€ä¸ªå…¶å­èŠ‚ç‚¹åº”è¯¥å—åˆ°å½±å“çš„çœŸå®DOMèŠ‚ç‚¹å’Œ

ä¸Šä¸€æ­¥åˆ›å»ºçš„diffæ•°ç»„ã€‚è¿™ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„diffsã€‚

`apply`å°†æ²¡æœ‰æœ‰æ„ä¹‰çš„è¿”å›å€¼ï¼Œå› ä¸ºå®ƒçš„ä¸»è¦ç›®çš„æ˜¯æ‰§è¡Œä¿®æ”¹DOMçš„å‰¯ä½œç”¨ã€‚

å®ƒçš„å®ç°éå¸¸ç®€å•ï¼Œåªæ˜¯åˆ†æ´¾æ¯ä¸ªå­èŠ‚ç‚¹è¦æ‰§è¡Œçš„é€‚å½“æ“ä½œã€‚

`create`å’Œ`modify` DOMèŠ‚ç‚¹çš„è¿‡ç¨‹è¢«ç§»åˆ°äº†å®ƒä»¬è‡ªå·±çš„å‡½æ•°ä¸­ã€‚

```js
function apply(el, childrenDiff) {
  const children = Array.from(el.childNodes);

  childrenDiff.forEach((diff, i) ={
    const action = Object.keys(diff)[0];
    switch (action) {
      case "remove":
        children[i].remove();
        break;

      case "modify":
        modify(children[i], diff.modify);
        break;

      case "create": {
        const child = create(diff.create);
        el.appendChild(child);
        break;
      }

      case "replace": {const child = create(diff.replace);
        children[i].replaceWith(child);
        break;
      }

      case "noop":
        break;
    }
  });
}

```

### äº‹ä»¶ç›‘å¬å™¨

åœ¨å¤„ç†åˆ›å»ºå’Œä¿®æ”¹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹æˆ‘ä»¬å¸Œæœ›å¦‚ä½•å¤„ç†äº‹ä»¶ç›‘å¬å™¨ã€‚

æˆ‘ä»¬å¸Œæœ›æ·»åŠ å’Œåˆ é™¤äº‹ä»¶ç›‘å¬å™¨éå¸¸ä¾¿å®œå’Œå®¹æ˜“ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿æˆ‘ä»¬æ°¸è¿œä¸ä¼šç•™ä¸‹ä»»ä½•æ‚¬æŒ‚çš„ç›‘å¬å™¨ã€‚

æˆ‘ä»¬è¿˜å¸Œæœ›å¼ºåˆ¶æ‰§è¡Œä¸€ä¸ªä¸å˜æ€§ï¼Œå³å¯¹äºä»»ä½•ç»™å®šçš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªäº‹ä»¶åº”è¯¥åªæœ‰ä¸€ä¸ªç›‘å¬å™¨ã€‚

è¿™å°†å·²ç»åœ¨æˆ‘ä»¬çš„APIä¸­æ˜¯è¿™ç§æƒ…å†µï¼Œå› ä¸ºäº‹ä»¶ç›‘å¬å™¨æ˜¯ä½¿ç”¨å±æ€§å¯¹è±¡ä¸­çš„é”®æŒ‡å®šçš„ï¼Œè€ŒJavaScriptå¯¹è±¡ä¸èƒ½æœ‰é‡å¤çš„é”®ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªæƒ³æ³•ã€‚æˆ‘ä»¬å‘DOMå¯¹è±¡èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªç”±æˆ‘ä»¬çš„åº“åˆ›å»ºçš„ç‰¹æ®Šå±æ€§ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­å¯ä»¥æ‰¾åˆ°è¯¥DOMèŠ‚ç‚¹çš„æ‰€æœ‰ç”¨æˆ·å®šä¹‰çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

```js
// åˆ›å»ºä¸€ä¸ªå±æ€§`_ui`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨DOMèŠ‚ç‚¹æœ¬èº«ä¸­ç›´æ¥å­˜å‚¨ä¸
// æˆ‘ä»¬çš„åº“ç›¸å…³çš„æ•°æ®ã€‚
// æˆ‘ä»¬åœ¨è¿™ä¸ªç©ºé—´ä¸­å­˜å‚¨è¯¥èŠ‚ç‚¹çš„äº‹ä»¶ç›‘å¬å™¨ã€‚
element['_ui'] = { listeners: { click: doSomething } }
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå•ä¸€çš„å‡½æ•°ï¼Œ`listener`ï¼Œä½œä¸ºæ‰€æœ‰èŠ‚ç‚¹çš„æ‰€æœ‰äº‹ä»¶çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

ä¸€æ—¦è§¦å‘äº‹ä»¶ï¼Œæˆ‘ä»¬çš„`listener`å‡½æ•°å°±ä¼šæ¥æ”¶å®ƒï¼Œå¹¶ä½¿ç”¨ç›‘å¬å™¨å¯¹è±¡å°†å…¶åˆ†æ´¾ç»™é€‚å½“çš„ç”¨æˆ·å®šä¹‰çš„å‡½æ•°æ¥å¤„ç†äº‹ä»¶ã€‚

```js
function listener(event) {
  const el = event.currentTarget
  const handler = el._ui.listeners[event.type]
  handler(event)
}
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™ç»™æˆ‘ä»¬å¸¦æ¥çš„å¥½å¤„æ˜¯ä¸éœ€è¦æ¯æ¬¡ç”¨æˆ·ç›‘å¬å™¨å‡½æ•°æ›´æ”¹æ—¶éƒ½è°ƒç”¨`addEventListener`å’Œ`removeEventListener`ã€‚

æ›´æ”¹äº‹ä»¶ç›‘å¬å™¨åªéœ€è¦åœ¨`listeners`å¯¹è±¡ä¸­æ›´æ”¹å€¼ã€‚ç¨åæˆ‘ä»¬å°†çœ‹åˆ°ä¸€ä¸ªæ›´æœ‰è¯´æœåŠ›çš„å¥½å¤„ã€‚

æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸“ç”¨å‡½æ•°æ¥å‘DOMèŠ‚ç‚¹æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ã€‚

```js
function setListener(el, event, handle) {
  if (el._ui.listeners[event] === undefined) {
    el.addEventListener(event, listener)
  }

  el._ui.listeners[event] = handle
}
```

æˆ‘ä»¬è¿˜æ²¡æœ‰åšçš„ä¸€ä»¶äº‹æ˜¯æ‰¾å‡º`properties`å¯¹è±¡ä¸­çš„ä»»ä½•ç»™å®šæ¡ç›®æ˜¯å¦æ˜¯äº‹ä»¶ç›‘å¬å™¨ã€‚

è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†å‘Šè¯‰æˆ‘ä»¬è¦ç›‘å¬çš„äº‹ä»¶çš„åç§°ï¼Œæˆ–è€…å¦‚æœå±æ€§ä¸æ˜¯äº‹ä»¶ç›‘å¬å™¨ï¼Œåˆ™è¿”å›`null`ã€‚

```js
function eventName(str) {
  if (str.indexOf('on') == 0) {
    // ä»¥`on`å¼€å¤´
    return str.slice(2).toLowerCase() // å»æ‰`on`çš„å°å†™åç§°
  }
  return null
}
```

### å±æ€§

å¥½çš„ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚ä½•æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ã€‚å¯¹äºå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨`setAttribute`ï¼Œå¯¹å§ï¼Ÿå—¯ï¼Œä¸æ˜¯ã€‚

å¯¹äºæŸäº›äº‹æƒ…ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨`setAttribute`å‡½æ•°ï¼Œè€Œå¯¹äºå…¶ä»–äº‹æƒ…ï¼Œæˆ‘ä»¬åº”è¯¥ç›´æ¥åœ¨DOMå¯¹è±¡ä¸­è®¾ç½®å±æ€§ã€‚

ä¾‹å¦‚ã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ª`<input type="checkbox">`å¹¶è°ƒç”¨`element.setAttribute("checked", true)`ï¼Œå®ƒå°†ä¸ä¼šè¢«é€‰ä¸­ğŸ™ƒã€‚

æ‚¨åº”è¯¥æ”¹ä¸ºåš`element["checked"] = true`ã€‚è¿™å°†æœ‰æ•ˆã€‚

æˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¯¥ä½¿ç”¨å“ªä¸ªå‘¢ï¼Ÿå—¯ï¼Œè¿™å¾ˆå¤æ‚ã€‚æˆ‘åªæ˜¯æ ¹æ®Elmçš„Htmlåº“çš„åšæ³•ç¼–åˆ¶äº†ä¸€ä¸ªåˆ—è¡¨ã€‚è¿™æ˜¯ç»“æœï¼š

```js
const props = new Set([
  'autoplay',
  'checked',
  'checked',
  'contentEditable',
  'controls',
  'default',
  'hidden',
  'loop',
  'selected',
  'spellcheck',
  'value',
  'id',
  'title',
  'accessKey',
  'dir',
  'dropzone',
  'lang',
  'src',
  'alt',
  'preload',
  'poster',
  'kind',
  'label',
  'srclang',
  'sandbox',
  'srcdoc',
  'type',
  'value',
  'accept',
  'placeholder',
  'acceptCharset',
  'action',
  'autocomplete',
  'enctype',
  'method',
  'name',
  'pattern',
  'htmlFor',
  'max',
  'min',
  'step',
  'wrap',
  'useMap',
  'shape',
  'coords',
  'align',
  'cite',
  'href',
  'target',
  'download',
  'download',
  'hreflang',
  'ping',
  'start',
  'headers',
  'scope',
  'span',
])

function setProperty(prop, value, el) {
  if (props.has(prop)) {
    el[prop] = value
  } else {
    el.setAttribute(prop, value)
  }
}
```

### åˆ›å»ºå’Œä¿®æ”¹

æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°è¯•ä»è™šæ‹ŸDOMåˆ›å»ºä¸€ä¸ªçœŸå®çš„DOMèŠ‚ç‚¹ã€‚

```js
function create(vnode) {
  // åˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹
  if (vnode.text !== undefined) {
    const el = document.createTextNode(vnode.text)
    return el
  }

  // ä½¿ç”¨æ­£ç¡®çš„æ ‡ç­¾åˆ›å»ºDOMå…ƒç´ ï¼Œå¹¶
  // å·²ç»æ·»åŠ æˆ‘ä»¬çš„ç›‘å¬å™¨å¯¹è±¡åˆ°å®ƒã€‚
  const el = document.createElement(vnode.tag)
  el._ui = { listeners: {} }

  for (const prop in vnode.properties) {
    const event = eventName(prop)
    const value = vnode.properties[prop]
    // å¦‚æœæ˜¯äº‹ä»¶è®¾ç½®å®ƒï¼Œå¦åˆ™å°†å€¼è®¾ç½®ä¸ºå±æ€§ã€‚
    event !== null ? setListener(el, event, value) : setProperty(prop, value, el)
  }

  // é€’å½’åˆ›å»ºæ‰€æœ‰å­èŠ‚ç‚¹å¹¶é€ä¸ªé™„åŠ ã€‚
  for (const childVNode of vnode.children) {
    const child = create(childVNode)
    el.appendChild(child)
  }

  return el
}
```

`modify`å‡½æ•°åŒæ ·ç›´æ¥ã€‚å®ƒè®¾ç½®å’Œåˆ é™¤èŠ‚ç‚¹çš„é€‚å½“å±æ€§ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤ç»™`apply`å‡½æ•°ï¼Œä»¥ä¾¿å®ƒæ›´æ”¹å­èŠ‚ç‚¹ã€‚

æ³¨æ„`modify`å’Œ`apply`ä¹‹é—´çš„é€’å½’ã€‚

```js
function modify(el, diff) {
  // åˆ é™¤å±æ€§
  for (const prop of diff.remove) {
    const event = eventName(prop)
    if (event === null) {
      el.removeAttribute(prop)
    } else {
      el._ui.listeners[event] = undefined
      el.removeEventListener(event, listener)
    }
  }

  // è®¾ç½®å±æ€§
  for (const prop in diff.set) {
    const value = diff.set[prop]
    const event = eventName(prop)
    event !== null ? setListener(el, event, value) : setProperty(prop, value, el)
  }

  // å¤„ç†å­èŠ‚ç‚¹
  apply(el, diff.children)
}
```

## å¤„ç†çŠ¶æ€

æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå®Œæ•´çš„è™šæ‹ŸDOMæ¸²æŸ“å®ç°ã€‚

ä½¿ç”¨`h`å’Œ`text`æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªVDOMï¼Œä½¿ç”¨`apply`å’Œ`diffList`æˆ‘ä»¬å¯ä»¥å°†å…¶å®ç°åˆ°çœŸå®çš„DOMå¹¶æ›´æ–°å®ƒã€‚

æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåœæ­¢ï¼Œä½†æˆ‘è®¤ä¸ºå®ç°æ²¡æœ‰ä¸€ç§ç»“æ„åŒ–çš„æ–¹å¼æ¥å¤„ç†çŠ¶æ€å˜åŒ–æ˜¯ä¸å®Œæ•´çš„ã€‚

æ¯•ç«Ÿï¼Œè™šæ‹ŸDOMçš„å…¨éƒ¨æ„ä¹‰åœ¨äºå½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‚¨ä¼šé‡å¤åœ°é‡æ–°åˆ›å»ºå®ƒã€‚

### API

æˆ‘ä»¬å°†ä»¥ä¸€ç§éå¸¸ç®€å•çš„æ–¹å¼è¿›è¡Œã€‚å°†æœ‰ä¸¤ç§ç”¨æˆ·å®šä¹‰çš„å€¼ï¼š

- åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼šåŒ…å«æ¸²æŸ“VDOMæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯çš„å€¼ã€‚
- åº”ç”¨ç¨‹åºæ¶ˆæ¯ï¼šåŒ…å«æœ‰å…³å¦‚ä½•æ›´æ”¹çŠ¶æ€çš„ä¿¡æ¯çš„å€¼ã€‚

æˆ‘ä»¬å°†è¦æ±‚ç”¨æˆ·å®ç°ä¸¤ä¸ªå‡½æ•°ï¼š

- `view`å‡½æ•°æ¥æ”¶åº”ç”¨ç¨‹åºçŠ¶æ€å¹¶è¿”å›VDOMã€‚
- `update`å‡½æ•°æ¥æ”¶åº”ç”¨ç¨‹åºçŠ¶æ€å’Œä¸€æ¡åº”ç”¨ç¨‹åºæ¶ˆæ¯ï¼Œå¹¶è¿”å›æ–°çš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚

è¿™è¶³ä»¥æ„å»ºä»»ä½•å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚

ç”¨æˆ·åœ¨ç¨‹åºå¼€å§‹æ—¶æä¾›è¿™ä¸¤ä¸ªå‡½æ•°ï¼ŒVDOMåº“å°†æ§åˆ¶ä½•æ—¶è°ƒç”¨å®ƒä»¬ã€‚ç”¨æˆ·æ°¸è¿œä¸ç›´æ¥è°ƒç”¨å®ƒä»¬ã€‚

æˆ‘ä»¬è¿˜éœ€è¦ä¸ºç”¨æˆ·æä¾›ä¸€ç§é€šè¿‡`update`å‡½æ•°å¤„ç†æ¶ˆæ¯çš„æ–¹å¼æ¥å‘å‡ºæ¶ˆæ¯ã€‚

æˆ‘ä»¬å°†é€šè¿‡æä¾›`enqueue`å‡½æ•°æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œå®ƒå°†æ¶ˆæ¯æ·»åŠ åˆ°è¦å¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚

ç”¨æˆ·éœ€è¦æä¾›çš„æœ€åå‡ ä»¶äº‹æ˜¯ä¸€ä¸ªåˆå§‹çŠ¶æ€ï¼Œä»¥å¼€å§‹ï¼Œå¹¶æä¾›ä¸€ä¸ªHTMLèŠ‚ç‚¹ï¼Œåœ¨å…¶ä¸­åº”è¯¥æ¸²æŸ“VDOMã€‚

æœ‰äº†è¿™äº›æœ€åçš„éƒ¨ä»¶ï¼Œæˆ‘ä»¬å°±æœ‰å®Œæ•´çš„APIã€‚

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåä¸º`init`çš„å‡½æ•°ï¼Œå®ƒå°†ä»ç”¨æˆ·é‚£é‡Œè·å–æ‰€æœ‰æ‰€éœ€çš„è¾“å…¥ï¼Œå¹¶å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

å®ƒå°†è¿”å›è¯¥åº”ç”¨ç¨‹åºçš„`enqueue`å‡½æ•°ã€‚

è¿™ç§è®¾è®¡å…è®¸æˆ‘ä»¬åœ¨åŒä¸€ä¸ªé¡µé¢ä¸Šè¿è¡Œå¤šä¸ªVDOMåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰è‡ªå·±çš„`enqueue`å‡½æ•°ã€‚

è¿™é‡Œæ˜¯ä¸€ä¸ªä½¿ç”¨æ­¤è®¾è®¡å®ç°çš„è®¡æ•°å™¨ï¼š

è®¡æ•°å™¨ï¼š0

```js
function view(state) {
  return [h('p', {}, [text(`è®¡æ•°å™¨: ${state.counter}`)])]
}

function update(state, msg) {
  return { counter: state.counter + msg }
}

const initialState = { counter: 0 }

const root = document.querySelector('.my-application')

// å¯åŠ¨åº”ç”¨ç¨‹åº
const { enqueue } = init(root, initialState, update, view)

// æ¯ç§’å¢åŠ è®¡æ•°å™¨ä¸€ã€‚
setInterval(() => enqueue(1), 1000)
```

### Initå‡½æ•°

æœ‰äº†å®Œå–„çš„APIï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹è¿™ä¸ª`init`å‡½æ•°åº”è¯¥å¦‚ä½•å·¥ä½œã€‚

æˆ‘ä»¬è‚¯å®šä¼šä¸ºæ¯æ¡æ¶ˆæ¯è°ƒç”¨ä¸€æ¬¡`update`ã€‚

ä½†æˆ‘ä»¬ä¸éœ€è¦æ¯æ¬¡çŠ¶æ€æ”¹å˜æ—¶éƒ½è°ƒç”¨`view`ï¼Œå› ä¸ºé‚£å¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬æ¯”æµè§ˆå™¨èƒ½å¤Ÿæ˜¾ç¤ºDOMæ›´æ–°æ›´é¢‘ç¹åœ°æ›´æ–°DOMã€‚

æˆ‘ä»¬å¸Œæœ›æ¯ä¸ªåŠ¨ç”»å¸§æœ€å¤šè°ƒç”¨ä¸€æ¬¡`view`ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿä»ä»–ä»¬æƒ³è¦çš„ä»»ä½•åœ°æ–¹è°ƒç”¨`enqueue`ï¼Œè€Œä¸ä¼šç ´åæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬åº”è¯¥æ¥å—`enqueue`ç”šè‡³åœ¨`update`å‡½æ•°å†…éƒ¨è¢«è°ƒç”¨ã€‚

æˆ‘ä»¬å°†é€šè¿‡è§£è€¦æ¶ˆæ¯æ’é˜Ÿã€æ›´æ–°çŠ¶æ€å’Œæ›´æ–°DOMæ¥å®ç°è¿™ä¸€ç‚¹ã€‚

å¯¹`enqueue`çš„è°ƒç”¨åªä¼šå°†æ¶ˆæ¯æ·»åŠ åˆ°æ•°ç»„ä¸­ã€‚

ç„¶åï¼Œåœ¨æ¯ä¸ªåŠ¨ç”»å¸§ä¸Šï¼Œæˆ‘ä»¬å°†å–å‡ºæ‰€æœ‰æ’é˜Ÿçš„æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡æ¯ä¸ªè°ƒç”¨`update`æ¥å¤„ç†å®ƒä»¬ã€‚

ä¸€æ—¦æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«å¤„ç†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`view`å‡½æ•°æ¸²æŸ“ç»“æœçŠ¶æ€ã€‚

ç°åœ¨è¿è¡Œåº”ç”¨ç¨‹åºåªåŒ…æ‹¬åœ¨æ¯ä¸ªåŠ¨ç”»å¸§ä¸Šé‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚

```js
// å¼€å§‹ç®¡ç†ä¸€ä¸ªHTMLå…ƒç´ çš„å†…å®¹ã€‚
function init(root, initialState, update, view) {
  let state = initialState // å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçŠ¶æ€
  let nodes = [] // è™šæ‹ŸDOMèŠ‚ç‚¹
  let queue = [] // æ¶ˆæ¯é˜Ÿåˆ—

  function enqueue(msg) {
    queue.push(msg)
  }

  // ç»˜åˆ¶å½“å‰çŠ¶æ€
  function draw() {
    let newNodes = view(state)
    apply(root, diffList(nodes, newNodes))
    nodes = newNodes
  }

  function updateState() {
    if (queue.length > 0) {
      let msgs = queue
      // ç”¨ä¸€ä¸ªç©ºæ•°ç»„æ›¿æ¢é˜Ÿåˆ—ï¼Œä»¥ä¾¿æˆ‘ä»¬ä¸ä¼šå¤„ç†
      // è¿™è½®æ–°æ’é˜Ÿçš„æ¶ˆæ¯ã€‚

      queue = []

      for (msg of msgs) {
        state = update(state, msg)
      }

      draw()

      // å®‰æ’ä¸‹ä¸€è½®çŠ¶æ€æ›´æ–°
      window.requestAnimationFrame(updateState)
    }
  }

  draw() // ç»˜åˆ¶åˆå§‹çŠ¶æ€
  updateState() // å¯åŠ¨çŠ¶æ€æ›´æ–°å‘¨æœŸ

  return { enqueue }
}
```

### ä¾¿åˆ©æ€§

æˆ‘ä»¬ç”¨æˆ·å¯ä»¥ä»ä»»ä½•ä»–ä»¬æƒ³è¦çš„åœ°æ–¹è°ƒç”¨`enqueue`ï¼Œä½†ç›®å‰ä»`update`å’Œ`view`å‡½æ•°å†…éƒ¨è°ƒç”¨å®ƒæœ‰ç‚¹éº»çƒ¦ã€‚

è¿™æ˜¯å› ä¸º`enqueue`ç”±`init`è¿”å›ï¼Œå®ƒæœŸæœ›`update`å’Œ`view`å·²ç»è¢«å®šä¹‰ã€‚

è®©æˆ‘ä»¬é¦–å…ˆé€šè¿‡å°†`enqueue`ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ç»™`update`æ¥æ”¹è¿›è¿™ä¸€ç‚¹ã€‚ç°åœ¨æˆ‘ä»¬çš„çŠ¶æ€æ›´æ–°çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```js
state = update(state, msg, enqueue)
```

è¶³å¤Ÿç®€å•ã€‚ç°åœ¨è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚ä½•åœ¨`view`å‡½æ•°ä¸­æ”¹è¿›è¿™ç§æƒ…å†µã€‚

ç”¨æˆ·åœ¨æ¸²æŸ“æœŸé—´ä¸ä¼šè°ƒç”¨`enqueue`ã€‚

ä»–ä»¬ä¼šåœ¨å“åº”æŸäº›äº‹ä»¶å¦‚`onClick`æˆ–`onInput`æ—¶è°ƒç”¨å®ƒã€‚

å› æ­¤ï¼Œå°†ç”¨æˆ·åˆ›å»ºçš„å¤„ç†è¿™äº›äº‹ä»¶çš„å‡½æ•°æ¥æ”¶`enqueue`ä½œä¸ºå‚æ•°ï¼Œä»¥åŠäº‹ä»¶å¯¹è±¡ï¼Œè¿™æ˜¯æœ‰æ„ä¹‰çš„ã€‚

æœ‰äº†è¿™ä¸ªï¼Œäº‹ä»¶å¤„ç†å¯ä»¥åƒè¿™æ ·ï¼š

```js
const button = h(
  'button',
  {
    onClick: (_event, enqueue) => {
      enqueue(1)
    },
  },
  [text('å¢åŠ è®¡æ•°å™¨')],
)
```

æˆ‘ä»¬å¯ä»¥è®©å®ƒæ›´å®¹æ˜“ï¼Œé€šè¿‡ä½¿äº‹ä»¶å¤„ç†ç¨‹åºè¿”å›çš„ä»»ä½•å€¼å¦‚æœä¸`undefined`ä¸åŒå°±è¢«è§†ä¸ºæ¶ˆæ¯ã€‚

è¿™å°†å…è®¸ä¸Šé¢çš„æŒ‰é’®è¢«å†™æˆï¼š

```js
const button = h('button', { onClick: () => 1 }, [text('å¢åŠ è®¡æ•°å™¨')])
```

é…·ï¼Œæˆ‘ä»¬å¦‚ä½•å®ç°å®ƒï¼Ÿæˆ‘ä»¬å•ä¸€çš„`listener`å‡½æ•°ï¼Œå®ƒåˆ†æ´¾äº‹ä»¶ï¼Œå°†éœ€è¦è®¿é—®`enqueue`ã€‚

é€šè¿‡`_ui`å¯¹è±¡ä¼ é€’å®ƒæœ€ç®€å•çš„æ–¹å¼ï¼Œå®ƒå·²ç»ä¿å­˜äº†ç”¨æˆ·å®šä¹‰çš„ç›‘å¬å™¨ã€‚

æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬çš„`listener`å®ç°å˜æˆäº†ï¼š

```js
function listener(event) {
  const el = event.currentTarget
  const handler = el._ui.listeners[event.type]
  const enqueue = el._ui.enqueue
  const msg = handler(event)
  if (msg !== undefined) {
    enqueue(msg)
  }
}
```

è¦åœ¨èŠ‚ç‚¹åˆ›å»ºæ—¶æ·»åŠ `enqueue`åˆ°`_ui`ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡`apply` `modify`å’Œ`create`ä¼ é€’å®ƒã€‚

```js
function apply(el, enqueue, childrenDiff) { ... }
function modify(el, enqueue, diff) { ... }
function create(enqueue, vnode) { ... }

```

æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬çš„å®Œæ•´åº“ç°åœ¨å°±å®Œæˆäº†ï¼æ‚¨å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹å®Œæ•´ä»£ç ã€‚

### å‚è€ƒèµ„æº

::: tip ä¼ é€é—¨
[åŸæ–‡åœ°å€](https://lazamar.github.io/virtual-dom/)
:::
